---
# Please do not edit this file directly; it is auto generated.
# Instead, please edit 06-map-many-eqtls.md in _episodes_rmd/
title: "Mapping Many Gene Expression Traits"
teaching: 30
exercises: 30
questions:
- "How do I map many genes?"
objectives:
- "????"
keypoints:
- "????"
source: Rmd
---



### Load Libraries  


~~~
library(tidyverse)
library(qtl2)
library(qtl2convert)
library(GGally)
library(broom)
library(knitr)
library(corrplot)
library(RColorBrewer)
library(qtl2ggplot)

source("../code/gg_transcriptome_map.R")
source("../code/qtl_heatmap.R")
~~~
{: .language-r}

### Load Data


~~~
# expression data
load("../data/attie_DO500_expr.datasets.RData")

# mapping data
load("../data/attie_DO500_mapping.data.RData")

probs = readRDS("../data/attie_DO500_genoprobs_v5.rds")

# phenotypes
load("../data/attie_DO500_clinical.phenotypes.RData")
~~~
{: .language-r}

### Data Selection

For this lesson, lets choose a random set of 50 gene expression phenotypes.




~~~
genes = colnames(norm)

sams <- sample(length(genes), 50, replace = FALSE, prob = NULL)
genes <- genes[sams]
~~~
{: .language-r}

### Expression Data

Lets check the distributin of these 50 gene expression phenotypes


~~~
par(mfrow=c(2,5))
for(gene in genes){
  hist(norm[,gene], main = names(norm[gene]))
  }
~~~
{: .language-r}

<img src="../fig/rmd-06-hist_untransformed-1.png" alt="plot of chunk hist_untransformed" width="612" style="display: block; margin: auto;" /><img src="../fig/rmd-06-hist_untransformed-2.png" alt="plot of chunk hist_untransformed" width="612" style="display: block; margin: auto;" /><img src="../fig/rmd-06-hist_untransformed-3.png" alt="plot of chunk hist_untransformed" width="612" style="display: block; margin: auto;" /><img src="../fig/rmd-06-hist_untransformed-4.png" alt="plot of chunk hist_untransformed" width="612" style="display: block; margin: auto;" /><img src="../fig/rmd-06-hist_untransformed-5.png" alt="plot of chunk hist_untransformed" width="612" style="display: block; margin: auto;" /><img src="../fig/rmd-06-hist_untransformed-6.png" alt="plot of chunk hist_untransformed" width="612" style="display: block; margin: auto;" />
The histogram indicates that distribution of these counts are normalised (as they should be).

### The Marker Map  

The marker map for each chromosome is stored in the `map` object. This is used to plot the LOD scores calculated at each marker during QTL mapping.  Here we are using the 69K grid marker file.  

We are using the same marker map as in the previous [lesson](https://smcclatchy.github.io/gene-expression-qtl/05-review-mapping-steps/index.html#the-marker-map)


### Genotype probabilities  

We have already calculated genotype probabilities which we loaded above called `probs`.  This contains the 8 state genotype probabilities using the 69k grid map of the same 500 DO mice that also have clinical phenotypes. 

We have explored this earlier in th previous [lesson](https://smcclatchy.github.io/gene-expression-qtl/05-review-mapping-steps/index.html#genotype-probabilities)


### [Kinship Matrix](https://smcclatchy.github.io/mapping/04-calc-kinship/)

The kinship matrix has already been calculated and loaded in above.  Again, we have explored this in the previous [lesson](https://smcclatchy.github.io/gene-expression-qtl/05-review-mapping-steps/index.html#kinship-matrix)


### Covariates    

Now let's add the necessary covariates. For `Hnf1b` expression data, let's see which covariates are significant.


~~~
###merging covariate data and expression data to test for sex, wave and diet_days.

cov.counts <- merge(covar, norm[,genes], by=c("row.names"), sort=F)

#testing covairates on expression data

tmp = cov.counts %>%
        dplyr::select(mouse, sex, DOwave, diet_days, names(cov.counts[,genes])) %>%
        gather(expression, value, -mouse, -sex, -DOwave, -diet_days) %>%
        group_by(expression) %>%
        nest()
mod_fxn = function(df) {
  lm(value ~ sex + DOwave + diet_days, data = df)
}
tmp = tmp %>%
  mutate(model = map(data, mod_fxn)) %>%
  mutate(summ = map(model, tidy)) %>%
  unnest(summ) 
#  kable(tmp, caption = "Effects of Sex, Wave & Diet Days on Expression")

tmp
~~~
{: .language-r}



~~~
# A tibble: 204 × 8
# Groups:   expression [51]
   expression         data     model  term     estimate std.e…¹ stati…²  p.value
   <chr>              <list>   <list> <chr>       <dbl>   <dbl>   <dbl>    <dbl>
 1 ENSMUSG00000020680 <tibble> <lm>   (Interc… -0.737   0.543    -1.36  1.75e- 1
 2 ENSMUSG00000020680 <tibble> <lm>   sexM      0.387   0.0884    4.38  1.55e- 5
 3 ENSMUSG00000020680 <tibble> <lm>   DOwave   -0.388   0.0398   -9.76  3.49e-20
 4 ENSMUSG00000020680 <tibble> <lm>   diet_da…  0.0119  0.00415   2.87  4.33e- 3
 5 ENSMUSG00000030660 <tibble> <lm>   (Interc…  0.866   0.538     1.61  1.08e- 1
 6 ENSMUSG00000030660 <tibble> <lm>   sexM      0.0240  0.0877    0.274 7.84e- 1
 7 ENSMUSG00000030660 <tibble> <lm>   DOwave   -0.464   0.0394  -11.8   1.88e-27
 8 ENSMUSG00000030660 <tibble> <lm>   diet_da…  0.00230 0.00411   0.559 5.76e- 1
 9 ENSMUSG00000097098 <tibble> <lm>   (Interc… -0.769   0.616    -1.25  2.13e- 1
10 ENSMUSG00000097098 <tibble> <lm>   sexM     -0.0486  0.100    -0.484 6.29e- 1
# … with 194 more rows, and abbreviated variable names ¹​std.error, ²​statistic
~~~
{: .output}



~~~
tmp %>%
  filter(term != "(Intercept)") %>%
  mutate(neg.log.p = -log10(p.value)) %>%
  ggplot(aes(term, neg.log.p)) +
    geom_point() +
    facet_wrap(~expression, ncol=10) +
    labs(title = "Significance of Sex, Wave & Diet Days on Expression") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
rm(tmp)
~~~
{: .language-r}

<img src="../fig/rmd-06-covariates sig-1.png" alt="plot of chunk covariates sig" width="612" style="display: block; margin: auto;" />

We can see that `DOwave` is the most significant.  However, given that a few are influenced by `sex` and `diet_days`, we will have to correct for it. 



~~~
# convert sex and DO wave (batch) to factors
pheno_clin$sex = factor(pheno_clin$sex)
pheno_clin$DOwave = factor(pheno_clin$DOwave)
pheno_clin$diet_days = factor(pheno_clin$DOwave)

covar = model.matrix(~sex + DOwave + diet_days, data = pheno_clin)
~~~
{: .language-r}

### [Performing a genome scan](https://smcclatchy.github.io/mapping/06-perform-genome-scan/) 

Now lets perform the genome scan!  We are also going to save our qtl results in an `Rdata` file to be used in further lesson. 

### QTL Scans


~~~
qtl.file = "../results/gene.norm_qtl_cis.trans_random.Rdata"

if(file.exists(qtl.file)) {
  load(qtl.file)
  } else {
    qtl = scan1(genoprobs = probs, 
                pheno = norm[,genes, drop = FALSE],
                kinship = K, 
                addcovar = covar, 
                cores = 2)
    save(qtl, file = qtl.file)
    }
~~~
{: .language-r}



~~~
Warning in gzfile(file, "wb"): cannot open compressed file '../results/
gene.norm_qtl_cis.trans_random.Rdata', probable reason 'No such file or
directory'
~~~
{: .warning}



~~~
Error in gzfile(file, "wb"): cannot open the connection
~~~
{: .error}

### QTL plots




~~~
par(mfrow=c(2,5))
for(i in 1:ncol(qtl)) {
  plot_scan1(x = qtl, 
             map = map, 
             lodcolumn = i, 
             main = colnames(qtl)[i])
  abline(h = 6, col = 2, lwd = 2)
  }
~~~
{: .language-r}

<img src="../fig/rmd-06-qtl_plots-1.png" alt="plot of chunk qtl_plots" width="612" style="display: block; margin: auto;" /><img src="../fig/rmd-06-qtl_plots-2.png" alt="plot of chunk qtl_plots" width="612" style="display: block; margin: auto;" /><img src="../fig/rmd-06-qtl_plots-3.png" alt="plot of chunk qtl_plots" width="612" style="display: block; margin: auto;" /><img src="../fig/rmd-06-qtl_plots-4.png" alt="plot of chunk qtl_plots" width="612" style="display: block; margin: auto;" /><img src="../fig/rmd-06-qtl_plots-5.png" alt="plot of chunk qtl_plots" width="612" style="display: block; margin: auto;" /><img src="../fig/rmd-06-qtl_plots-6.png" alt="plot of chunk qtl_plots" width="612" style="display: block; margin: auto;" />

### QTL Peaks

We are also going to save our peak results so we can use these again else where


~~~
lod_threshold = 6
peaks = find_peaks(scan1_output = qtl, 
                   map = map, 
                   threshold = lod_threshold, 
                   peakdrop = 4, 
                   prob = 0.95)
~~~
{: .language-r}


~~~
kable(peaks %>% 
        dplyr::select(-lodindex) %>% 
        arrange(chr, pos), caption = "Expression QTL (eQTL) Peaks with LOD >= 6")

write_csv(peaks, "../results/gene.norm_qtl_peaks_random.csv")
~~~
{: .language-r}


~~~
 [1] "Table: Expression QTL (eQTL) Peaks with LOD >= 6"                          
 [2] ""                                                                          
 [3] "|lodcolumn          |chr |        pos|        lod|      ci_lo|      ci_hi|"
 [4] "|:------------------|:---|----------:|----------:|----------:|----------:|"
 [5] "|ENSMUSG00000032549 |1   | 130.711212|   8.223569| 129.753531| 134.211141|"
 [6] "|ENSMUSG00000024712 |1   | 188.705836|   6.065488|  74.189728| 193.645480|"
 [7] "|ENSMUSG00000085012 |1   | 189.257133|   6.435918|  36.365564| 190.138440|"
 [8] "|ENSMUSG00000097857 |2   |  52.778906|   9.251783|  52.653945|  56.621450|"
 [9] "|ENSMUSG00000042064 |2   |  70.020081|  13.031306|  69.451695|  70.126091|"
[10] "|ENSMUSG00000038903 |2   | 163.582672|   6.274302|  11.692833| 165.479592|"
[11] "|ENSMUSG00000022824 |2   | 164.022416|  18.911033| 164.022416| 164.076561|"
[12] "|ENSMUSG00000016252 |2   | 174.476126|  20.820158| 174.165673| 174.666194|"
~~~
{: .output}



~~~
Error: Cannot open file for writing:
* '../results/gene.norm_qtl_peaks_random.csv'
~~~
{: .error}

### QTL Peaks Figure


~~~
peaks = peaks %>%
  arrange(lodcolumn)
plot_peaks(peaks, 
           map, 
           col = c("blue","red"), 
           lwd = 3, 
           tick_height = 0.8, 
           gap = 0, 
           main = "LOD > 6")
box()
~~~
{: .language-r}

<img src="../fig/rmd-06-qtl_peaks_figure-1.png" alt="plot of chunk qtl_peaks_figure" width="612" style="display: block; margin: auto;" />

~~~
ggplot_peaks(peaks, 
             map, 
             col = c("blue","red"), 
             legend.title = "LOD > 6") 
~~~
{: .language-r}

<img src="../fig/rmd-06-qtl_peaks_figure-2.png" alt="plot of chunk qtl_peaks_figure" width="612" style="display: block; margin: auto;" />


~~~
qtl_heatmap(qtl = qtl, map = map, low.thr = 3.5)
~~~
{: .language-r}

<img src="../fig/rmd-06-qtl_heatmap-1.png" alt="plot of chunk qtl_heatmap" width="612" style="display: block; margin: auto;" />

> ## Challenge
> What do the qtl scans for all gene exression traits look like?  
> Don't worry, we've done the qtl scans for you!!!
> You can read in this file, `..data/gene.norm_qtl_all.genes.Rdata`, which are the `scan1` results for all gene expression traits. 
>
> > ## Solution
> > 
> > 
> > ~~~
> > load("..data/gene.norm_qtl_all.genes.Rdata")
> > 
> > lod_threshold = 6
> > peaks = find_peaks(scan1_output = qtl, 
> >                map = map, 
> >                threshold = lod_threshold, 
> >                peakdrop = 4, 
> >                prob = 0.95)
> > write_csv(peaks, "../results/gene.norm_qtl_peaks.csv")
> > 
> > ## Peaks Figure
> > peaks = peaks %>% arrange(lodcolumn)
> > plot_peaks(peaks, 
> >            map, 
> >            col = c("blue","red"), 
> >            lwd = 3, 
> >            tick_height = 0.8, 
> >            gap = 0, 
> >            main = "LOD > 6")
> > box()
> > ggplot_peaks(peaks, 
> >              map, 
> >              col = c("blue","red"), 
> >              legend.title = "LOD > 6") 
> > 
> > ## Heat Map
> > qtl_heatmap(qtl = qtl, map = map, low.thr = 3.5)
> > ~~~
> > {: .language-r}
> {: .solution}
{: .challenge}
